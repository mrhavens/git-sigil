#!/bin/bash

set -euo pipefail

# â”€â”€ Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REPO_NAME="git-sigil"
REMOTE_LABEL="radicle"
WORKING_DIR="$(pwd)"
METADATA_FILE=".radicle-link.md"
SCRIPT_VERSION="v1.0"

# â”€â”€ Step 1: Detect Environment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
USER_NAME="$(whoami)"
HOST_NAME="$(hostname)"
OS_INFO="$(uname -a)"
IS_WSL=$(grep -i microsoft /proc/version &>/dev/null && echo "Yes" || echo "No")
IS_DOCKER=$(grep -qa 'docker' /proc/1/cgroup && echo "Yes" || echo "No")
ARCHITECTURE="$(uname -m)"
IP_ADDR=$(hostname -I | awk '{print $1}')
MAC_ADDR=$(ip link | awk '/ether/ {print $2}' | head -n 1)
UPTIME="$(uptime -p | sed 's/up //')"
CPU_MODEL=$(lscpu | grep 'Model name' | sed 's/Model name:[ \t]*//')
TOTAL_RAM=$(free -g | awk '/^Mem:/ {print $2}')

# â”€â”€ Step 2: Initialize & Push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
rad init --name "$REPO_NAME" --description "Radicle link for $REPO_NAME"
rad push

PROJECT_ID=$(rad self | grep "Project ID" | awk '{print $NF}')
PEER_ID=$(rad self | grep "Peer ID" | awk '{print $NF}')
COMMIT_SHA=$(git rev-parse HEAD)
TREE_SHA=$(git rev-parse HEAD^{tree})
TIMESTAMP=$(date -Is)

# â”€â”€ Step 3: Add Custom Seed Node â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
rad node config set seeds "[\"kairos-seed.thefoldwithin.earth:8776\"]"

# â”€â”€ Step 4: Form Gateway URLs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GARDEN_URL="https://app.radicle.xyz/nodes/seed.radicle.garden/rad:${PROJECT_ID}"
KAIROS_URL="https://app.radicle.xyz/nodes/kairos-seed.thefoldwithin.earth/rad:${PROJECT_ID}"
RAW_URL="https://app.radicle.network/rad:${PROJECT_ID}"

# â”€â”€ Step 5: Write Metadata â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cat > "$METADATA_FILE" <<EOF
# ðŸ”— Radicle Project Link Metadata

- **Repo Name**: \`$REPO_NAME\`
- **Peer ID**: \`$PEER_ID\`
- **Project ID**: \`$PROJECT_ID\`
- **Local Path**: \`$WORKING_DIR\`
- **Remote Label**: \`$REMOTE_LABEL\`
- **Default Branch**: \`master\`
- **Script Version**: \`$SCRIPT_VERSION\`

---

## ðŸŒ Gateway Access URLs

- Garden ðŸŒ±: [$GARDEN_URL]($GARDEN_URL)
- Kairos ðŸŒ€: [$KAIROS_URL]($KAIROS_URL)
- Raw ðŸ”§: [$RAW_URL]($RAW_URL)

---

## ðŸ“¦ Commit Metadata

- **Commit SHA**: \`$COMMIT_SHA\`
- **Tree SHA**: \`$TREE_SHA\`
- **Timestamp**: \`$TIMESTAMP\`

---

## ðŸ’» Platform Metadata

- **User**: \`$USER_NAME\`
- **Hostname**: \`$HOST_NAME\`
- **Architecture**: \`$ARCHITECTURE\`
- **IP Address**: \`$IP_ADDR\`
- **MAC Address**: \`$MAC_ADDR\`
- **Uptime**: \`$UPTIME\`
- **CPU**: \`$CPU_MODEL\`
- **RAM (GB)**: \`$TOTAL_RAM\`
- **Running in Docker**: \`$IS_DOCKER\`
- **Running in WSL**: \`$IS_WSL\`
- **OS Info**: \`$OS_INFO\`

---

_Auto-generated by \`gitfield-radicle\` on $TIMESTAMP._
EOF

# â”€â”€ Step 6: Output for Human Use â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo -e "\nâœ… Radicle push complete for \033[1m$REPO_NAME\033[0m"
echo -e "ðŸŒ± Garden URL: \033[4m$GARDEN_URL\033[0m"
echo -e "ðŸŒ€ Kairos URL: \033[4m$KAIROS_URL\033[0m"
echo -e "ðŸ”§ Raw Gateway: \033[4m$RAW_URL\033[0m"
echo -e "\nðŸ§¬ Metadata stored in: $METADATA_FILE"
echo -e "ðŸ“ Project ID: $PROJECT_ID"
echo -e "ðŸ‘¤ Peer ID: $PEER_ID"
echo -e "ðŸ•’ Timestamp: $TIMESTAMP\n"
